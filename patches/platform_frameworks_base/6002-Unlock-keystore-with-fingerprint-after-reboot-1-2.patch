From a0ad4c9c7a6e0424367e2abfcf732ba31094572c Mon Sep 17 00:00:00 2001
From: xyyx <xyyx@mail.ru>
Date: Tue, 9 Jan 2018 19:36:56 +0100
Subject: [PATCH 6/6] Unlock keystore with fingerprint after reboot (1/2)

Signed-off-by: spezi77 <spezi7713@gmx.net>
Signed-off-by: AndroPlus <mail@andro.plus>
---
 core/java/android/provider/Settings.java                    | 6 ++++++
 .../src/com/android/keyguard/KeyguardUpdateMonitor.java     | 4 +++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index ab15918909c..d3d60733c22 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -4440,6 +4440,12 @@ public final class Settings {
         public static final String DOUBLE_TAP_SLEEP_LOCKSCREEN = "double_tap_sleep_lockscreen";
 
         /**
+         * Unlock keystore with fingerprint after reboot
+         * @hide
+         */
+        public static final String FP_UNLOCK_KEYSTORE = "fp_unlock_keystore";
+
+         /**
          * Settings to backup. This is here so that it's in the same place as the settings
          * keys and easy to update.
          *
diff --git a/packages/SystemUI/src/com/android/keyguard/KeyguardUpdateMonitor.java b/packages/SystemUI/src/com/android/keyguard/KeyguardUpdateMonitor.java
index 4d93b0f0e66..ffc46618873 100644
--- a/packages/SystemUI/src/com/android/keyguard/KeyguardUpdateMonitor.java
+++ b/packages/SystemUI/src/com/android/keyguard/KeyguardUpdateMonitor.java
@@ -706,7 +706,9 @@ public class KeyguardUpdateMonitor implements TrustManager.TrustListener {
     }
 
     public boolean isUnlockingWithFingerprintAllowed() {
-        return mStrongAuthTracker.isUnlockingWithFingerprintAllowed();
+        return mStrongAuthTracker.isUnlockingWithFingerprintAllowed()
+            || (Settings.System.getInt(mContext.getContentResolver(),
+            Settings.System.FP_UNLOCK_KEYSTORE, 0) == 1);
     }
 
     public boolean isUserInLockdown(int userId) {
-- 
2.17.1

